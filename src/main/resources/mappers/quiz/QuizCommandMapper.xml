<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team.jpquiz.quiz.command.infrastructure.QuizCommandMapper">

    <!-- 문제 pool 전체 개수 -->
    <select id="countAllQuestions" resultType="int">
        SELECT COUNT(*)
        FROM quiz_questions
    </select>

    <!-- 시작 시점에 랜덤 문제 ID를 count개 추출 -->
    <select id="findRandomQuestionIds" resultType="long">
        SELECT qq.question_id
        FROM quiz_questions qq
        ORDER BY RAND()
        LIMIT #{count}
    </select>

    <!-- 문제별 보기 순서를 CSV로 고정 저장하기 위한 값 생성 -->
    <select id="findChoiceOrderCsv" resultType="string">
        SELECT GROUP_CONCAT(qc.choice_id ORDER BY RAND() SEPARATOR ',')
        FROM quiz_choices qc
        WHERE qc.question_id = #{questionId}
    </select>

    <!-- 퀴즈 시도 생성 (생성 PK는 keyProperty=attemptId로 회수) -->
    <insert id="insertQuizAttempt"
            parameterType="map"
            useGeneratedKeys="true"
            keyProperty="attemptId"
            keyColumn="attempt_id">
        INSERT INTO quiz_attempts (
            user_id,
            total_questions,
            started_at,
            created_at,
            updated_at
        ) VALUES (
            #{userId},
            #{totalQuestions},
            NOW(),
            NOW(),
            NOW()
        )
    </insert>

    <!-- attempt의 각 문제 배정/순서/보기순서(choice_order) 저장 -->
    <insert id="insertQuizAttemptQuestion">
        INSERT INTO quiz_attempt_questions (
            attempt_id,
            seq,
            question_id,
            choice_order
        ) VALUES (
            #{attemptId},
            #{seq},
            #{questionId},
            #{choiceOrder}
        )
    </insert>

</mapper>
